---
title: "Practica 2"
author: "Brais Santos Negreira / Jorge Álvarez Gracia"
date: "Diciembre 2021"
output: 
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
---

******
#  Introducción

## Elección del DataSet

******

El conjunto de datos que hemos elegido está en la siguiente url: https://www.kaggle.com/fedesoriano/heart-failure-prediction. Se ha escogido ya que es una temática muy interesante las enfermedades cardiovasculares y al mismo tiempo comprobamos que haya campos numéricos y categóricos. Lo que pretende responder es como afecta o no las enfermedades cardiovasculares en función de las caracterísitcas de las personas.


******
# Carga del dataset

******

Se lee el fichero "heart.csv".
```{r,eval=TRUE,echo=TRUE}

heart <- read.csv("heart.csv",sep=",")

```


## Explicación de las variables
A continuación, obtenemos el listado de variables:

```{r,eval=TRUE,echo=TRUE}

str(heart)

```

<li> __Age__ : edad del paciente.</li> 
<li> __Sex__ : sexo del paciente. </li> 
<li> __ChestPainType__ : Tipo de dolor del pecho. </li>
<li> __RestingBP__ : presión arterial en reposo (sistólica). </li>
<li> __Cholesterol__ : colesterol sérico. </li>
<li> __FastingBS__ : azúcar en sangre en ayunas.</li>
<li> __RestingECG__: resultados del electrocardiograma en reposo. </li>
<li> __MaxHR__: frecuencia cardíaca máxima alcanzada. </li>
<li> __ExerciseAngina__: angina inducida por el ejercicio. </li>
<li> __Oldpeak__ : ejercicio inducido por la depresión (ST) en relación con el descanso. </li>
<li> __ST_Slope__ : pendiente del segmento ST del ejercicio pico. </li>
<li> __HeartDisease__   : clase de salida. </li>

<br>
Se muestra un resumen de las variables.

```{r,eval=TRUE,echo=TRUE}

summary(heart)

```

A partir de esto, se puede concluir con que hay 12 variables y 918 observaciones. También se aprecia que en el dataset hay 3 tipos de datos:

<li> Variables numéricas: Oldpeak. </li>
<li> Variables de tipo carácter: Sex, ChestPainType, RestingECG, ExerciseAngina, ST_Slope. </li>
<li> Variables de tipo entero: Age, RestingBP, Cholesterol, FastingBS, MaxHR, HeartDisease. </li>



# Preprocesado de datos

## Conersión y estandarización

Pasamos los valores int a numeric y los char a factor.

```{r,eval=TRUE,echo=TRUE}

heart$Age <- as.numeric(heart$Age)
heart$Sex <- as.factor(heart$Sex)
heart$ChestPainType <- as.factor(heart$ChestPainType)
heart$RestingBP <- as.numeric(heart$RestingBP)
heart$Cholesterol <- as.numeric(heart$Cholesterol)
heart$FastingBS <- as.numeric(heart$FastingBS)
heart$RestingECG  <- as.factor(heart$RestingECG)
heart$MaxHR <- as.numeric(heart$MaxHR)
heart$ExerciseAngina <- as.factor(heart$ExerciseAngina)
heart$ST_Slope <- as.factor(heart$ST_Slope)
heart$HeartDisease <- as.numeric(heart$HeartDisease)

```


## Estudio de outliers

En este apartado, se va a mostrar el diagrama de cajas de cada una de las variables numéricas para comprobar si hay posibles outliers.

__Age__:

Se aprecia que en la variable "Age" no hay ningún valor extremo.
```{r,eval=TRUE,echo=TRUE}

boxplot(heart$Age,main="Edad del paciente")

```

```{r,eval=TRUE,echo=TRUE}

boxplot.stats(heart$Age)$out

```


__RestingBP__:

En el campo "RestingBP" se observa algunos outliers, pero no se eliminarán debido a que la presión arterial sistólica puede tener valores superiores a 180 (esto sería una crisis de hipertensión).

```{r,eval=TRUE,echo=TRUE}

boxplot(heart$RestingBP,main="Presión arterial en reposo")

```


```{r,eval=TRUE,echo=TRUE}

boxplot.stats(heart$RestingBP)$out

```

__Cholesterol__:

En esta variable se aprecian una serie de valores extremos, pero por el contrario no es extraño ya que un colesterol de 603 se puede tener (https://www.tuotromedico.com/parametros/colesterol-en-sangre-alto.htm), aunque es un valor muy elevado. También se puede tener el valor 100 que es óptimo.
```{r,eval=TRUE,echo=TRUE}

boxplot(heart$Cholesterol,main="Colesterol")

```


```{r,eval=TRUE,echo=TRUE}

boxplot.stats(heart$Cholesterol)$out

```


__MaxHR__ :

Se puede apreciar que hay dos valores extremos: 60 y 63. Esas frecuencias cardíacas __máximas__ son muy bajas y por tanto lo podemos detectar como valores extraños. 
```{r,eval=TRUE,echo=TRUE}

boxplot(heart$MaxHR,main="Frecuencia cardíaca máxima alcanzada")

```

```{r,eval=TRUE,echo=TRUE}

boxplot.stats(heart$MaxHR)$out

```
A continuación, sustituímos esos valores por NA y luego lo trataremos mediante Knn.

```{r,eval=TRUE,echo=TRUE}

posMaxHR <- which(heart$MaxHR==60 | heart$MaxHR==63)


heart$MaxHR[posMaxHR] <- NA


```

Se aplica kNN para ponerle un valor en función de sus vecinos más cercanos.

```{r,eval=TRUE,echo=TRUE}
library(VIM)

MaxHR_new <- kNN(heart,variable="MaxHR",dist_var =c("Age","Sex","ChestPainType","FastingBS","RestingECG","ExerciseAngina","ST_Slope","HeartDisease"),k=3)
MaxHR_new <- MaxHR_new$MaxHR

heart$MaxHR <- MaxHR_new


```

Se comprueba  que en esa posición hay otro valor diferente.

```{r,eval=TRUE,echo=TRUE}

heart$MaxHR[posMaxHR]


```



## Estudio de Valores nulos

Se aprecia que no hay ningun valor NA. 

```{r,eval=TRUE,echo=TRUE}

colSums(is.na(heart))

```
A continuación, comprobaremos si algún campo tiene un valor 0.

```{r,eval=TRUE,echo=TRUE}

colSums(heart == 0)

```
Viendo esto, se puede decir que no tiene sentido que los campos RestingBP y Cholesterol tengan ceros. En este caso, podemos hablar de información perdida.

```{r,eval=TRUE,echo=TRUE}

posRestingBP <- which(heart$RestingBP == 0)

posCholesterol <- which(heart$Cholesterol == 0)

heart$RestingBP[posRestingBP] <- NA

heart$Cholesterol[posCholesterol] <- NA


```

Para esos 0, hemos metido NA ya que es un valor desconocido y ahora miraremos mediante Knn como tratar esos datos.

<br>
Para solucionar estos valores perdidos, vamos a hacer uso de la función knn.

```{r,eval=TRUE,echo=TRUE}



RestingBP_new <- kNN(heart,variable="RestingBP",dist_var =c("Age","Sex","ChestPainType","FastingBS","RestingECG","ExerciseAngina","ST_Slope","HeartDisease"),k=3)
RestingBP_new <- RestingBP_new$RestingBP

heart$RestingBP <- RestingBP_new

Cholesterol_new <- kNN(heart,variable="Cholesterol",dist_var =c("Age","Sex","ChestPainType","FastingBS","RestingECG","ExerciseAngina","ST_Slope","HeartDisease"),k=3)
Cholesterol_new <- Cholesterol_new$Cholesterol

heart$Cholesterol <- Cholesterol_new





```

Se comprueba que ya no hay valores pérdidos en esas posiciones:

```{r,eval=TRUE,echo=TRUE}


heart$RestingBP[posRestingBP]
heart$Cholesterol[posCholesterol]



```

Observamos que los valores NA fueron sustitídos por otros en función de las características de los demás atributos.
<br>
Finalmente, vemos que ya no hay ningun valor perdido.

```{r,eval=TRUE,echo=TRUE}

colSums(is.na(heart))

```


## Normalización 

En este apartado, lo que vamos a hacer es normalizar el campo Age usando min-max. Se creará un nuevo campo llamado Age_nor y se añadirá al dataset.

```{r,eval=TRUE,echo=TRUE}

Age_nor <- (2*(heart$Age-min(heart$Age))/(max(heart$Age)-min(heart$Age)))-1
heart <- cbind(heart,Age_nor)

```

Estos datos, están en el intervalo [-1,1]

```{r,eval=TRUE,echo=TRUE}

min(heart$Age_nor)
max(heart$Age_nor)

```

## Discretización de variables

En esta apartado, también usaremos la variable "Age" para discretizarla en diferentes rangos y se añadirá al dataset con el nombre Age_dis.

```{r,eval=TRUE,echo=TRUE}

Age_dist <- cut(heart$Age, breaks = c(0,40,60,80), labels = c("(0-40]","(40,60]","(60,80]"))

heart <- cbind(heart,Age_dist)

```



# Análisis de los datos

## Análisis descriptivo de las variables

Ahora, tenemos el dataset sin valores vacíos así como nuevas variables normalizadas y discretas.
<br>
Por lo tanto, se muestra un resumen del dataset en el cual podemos ver la media, moda, cuartiles y valores mínimos y máximos en el caso de variables numéricas.
En el caso de los factores, podemos ver el número de ocurrencias que tiene dicho valor.

```{r,eval=TRUE,echo=TRUE}

summary(heart)

```
## Estudio normalidad de las variables

### Comprobación de la normalidad

En este apartado, comprobaremos la normalidad de las variables numéricas, pero las que no son dicotómicas.

__Age__


```{r,eval=TRUE,echo=TRUE}

qqnorm(heart$Age)
qqline(heart$Age)

```
A simple vista, se puede ver que los datos están por la recta menos por los lados y podríamos asumir normalidad. De todas formas comprobaremos esto con el test de shapiro y Lilliefors.

```{r,eval=TRUE,echo=TRUE}

shapiro.test(heart$Age)

```

```{r,eval=TRUE,echo=TRUE}

library(nortest)
lillie.test(heart$Age)

```

Viendo ambos test, se puede apreciar que no sigue una distribucción normal la variable "Age".

__RestingBP__

```{r,eval=TRUE,echo=TRUE}

qqnorm(heart$RestingBP)
qqline(heart$RestingBP)

```

Tal como se aprecia, los valores no suelen estar en la recta y por lo tanto no sigue una distribucción normal.

__Cholesterol__

```{r,eval=TRUE,echo=TRUE}

qqnorm(heart$Cholesterol)
qqline(heart$Cholesterol)

```

Se aprecia que bastantes puntos están muy por fuera de la recta. Con esto, concluímos que el campo Cholesterol no sigue una distribución normal.

__MaxHR__

```{r,eval=TRUE,echo=TRUE}

qqnorm(heart$MaxHR)
qqline(heart$MaxHR)

```

Se observa que los puntos suelen seguir la recta, menos en algunos lados.
<br>
Para estar más seguros aplicamos los test de shapiro y Lilliefors.

```{r,eval=TRUE,echo=TRUE}

shapiro.test(heart$MaxHR)

```
```{r,eval=TRUE,echo=TRUE}

lillie.test(heart$MaxHR)

```

Según el test de shapiro, podemos afirmar que la variable MaxHR, pero según el test de lillie no.

__Oldpeak__

```{r,eval=TRUE,echo=TRUE}

qqnorm(heart$Oldpeak)
qqline(heart$Oldpeak)

```

A simple vista, se observa que muchos puntos están fuera de la recta y con esto podemos decir que no sigue una distribución normal.

__Age_nor__

```{r,eval=TRUE,echo=TRUE}

qqnorm(heart$Age_nor)
qqline(heart$Age_nor)

```

Se aprecia que muchos puntos siguen la recta ( similar a la variable Age sin normalizar ).
<br>
A continuación, aplicamos los siguientes test:

```{r,eval=TRUE,echo=TRUE}

shapiro.test(heart$Age_nor)

```

```{r,eval=TRUE,echo=TRUE}

lillie.test(heart$Age_nor)

```
Nos da la misma información que la variable Age. Por tanto, podemos decir que no sigue una distribución normal.

### Teorema del límite central

Dado que el tamaño de este dataset es >30, se puede decir por el teorema del límite central que las variables mencionadas anteriormente siguen una distribución normal.


## Contraste de hipótesis

### Queremos saber si el colesterol de las mujeres es mayor que el de los hombres

Primero, calculamos dos variables para obtener el colesterol de hombres y mujeres.
```{r,eval=TRUE,echo=TRUE}

colHom <- heart$Cholesterol[heart$Sex=="M"]

colMuj <- heart$Cholesterol[heart$Sex=="F"]

```

Como hipotesis nula, se quiere saber si el colesterol en mujeres es igual que en el de los hombres.
<br>
Como hipotesis alternativa se quiere saber si el colesterol en mujeres es mayor que en hombres.

$$
\left\{
\begin{array}{ll}
H_{0}: &  \mu_M=\mu_H \\
H_{1}: & \mu_M>\mu_H
\end{array}
\right.\\
\ Hipótesis\ unilateral
$$
Por el teorema del límite central, asumimos normalidad ya que tenemos una muestra con n>30. Esto, es un contraste de hipótesis de dos muestras independientes sobre la media (varianzas desconocidas).
Es un test unilateral por la derecha.
<br>

Ahora, comprobamos la homocesdasticidad.


```{r,eval=TRUE,echo=TRUE}

var.test(colMuj, colHom)

```
Se observa que p-value < 0.05. Por tanto, las varianzas no son iguales.
<br>

A continuación, aplicamos el test de este contraste de hipótesis.

```{r,eval=TRUE,echo=TRUE}

t.test( colMuj,colHom , var.equal=FALSE, alternative = "greater")

```

Se aprecia, que p-value < 0.05. Por tanto, se rechaza la hipótesis nula y se acepta la alternativa de que las mujeres tiene más colesterol que los hombres.

### Azúcar en sangre es mayor en hombres que en mujeres teniendo ambos enfermedades cardíacas


Primero, calculamos dos variables para obtener las enfermades cardíacas de hombres y mujeres.
```{r,eval=TRUE,echo=TRUE}

carHom <- heart$FastingBS[heart$Sex=="M" & heart$HeartDisease=="1"]

carMuj <- heart$FastingBS[heart$Sex=="F" & heart$HeartDisease=="1"]

```

Como hipotesis nula, se quiere saber si las enfermades cardíacas es igual en hombres que en mujeres.
<br>
Como hipotesis alternativa se quiere saber si las enfermades cardíacas es mayor en hombres que en mujeres.

$$
\left\{
\begin{array}{ll}
H_{0}: &  \mu_H=\mu_M \\
H_{1}: & \mu_H>\mu_M
\end{array}
\right.\\
\ Hipótesis\ unilateral
$$

Por el teorema del límite central, asumimos normalidad ya que tenemos una muestra con n>30. Esto, es un contraste de hipótesis de dos muestras independientes sobre la media (varianzas desconocidas).
Es un test unilateral por la derecha.
<br>

Ahora, comprobamos la homocesdasticidad.


```{r,eval=TRUE,echo=TRUE}

var.test(carHom,carMuj)

```
Se observa que p-value > 0.05. Por tanto, las varianzas son iguales.
<br>

A continuación, aplicamos el test de este contraste de hipótesis.

```{r,eval=TRUE,echo=TRUE}

t.test( carHom,carMuj , var.equal=TRUE, alternative = "greater")

```

Se aprecia, que p-value > 0.05. Por tanto, se acepta la hipótesis nula de que los hombres con enfermedad cardíaca tienen igual azucar en sangre que las mujeres con enfermedad cardíaca.
